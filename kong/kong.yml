# kong/kong.yml
_format_version: "3.0"
_transform: true

services:
  # Main API Service (Orchestrator)
  - name: hydrogen-api
    url: http://orchestrator:8000
    connect_timeout: 60000
    write_timeout: 300000  # 5 minutes for long-running queries
    read_timeout: 300000
    retries: 3
    routes:
      - name: api-query
        paths:
          - /api/query
        strip_path: false
        methods:
          - POST
      - name: api-status
        paths:
          - /api/status
        strip_path: false
        methods:
          - GET
      - name: api-health
        paths:
          - /api/health
        strip_path: false
        methods:
          - GET
    plugins:
      - name: rate-limiting
        config:
          minute: 60
          hour: 1000
          policy: local
      - name: request-size-limiting
        config:
          allowed_payload_size: 10  # MB
      - name: correlation-id
        config:
          header_name: X-Request-ID
          generator: uuid
          echo_downstream: true

  # WebSocket Service (HTTP only for compatibility)
  - name: hydrogen-websocket
    url: http://orchestrator:8000
    routes:
      - name: websocket
        paths:
          - /ws
        strip_path: false
        protocols:
          - http
          - https

  # Tool Service (MCP Server)
  - name: hydrogen-tools
    url: http://mcp-server:8000
    connect_timeout: 30000
    write_timeout: 60000
    read_timeout: 60000
    routes:
      - name: tool-execute
        paths:
          - /tools/execute
        strip_path: true
        methods:
          - POST
      - name: tool-list
        paths:
          - /tools/list
        strip_path: true
        methods:
          - GET
      - name: tool-reload
        paths:
          - /tools/reload
        strip_path: true
        methods:
          - POST
    plugins:
      - name: rate-limiting
        config:
          minute: 100
          policy: local

  # Data Ingestion Service
  - name: hydrogen-ingestion
    url: http://data-ingestion:8000
    connect_timeout: 30000
    write_timeout: 600000  # 10 minutes for large ingestions
    read_timeout: 600000
    routes:
      - name: ingest-trigger
        paths:
          - /ingest/trigger
        strip_path: true
        methods:
          - POST
    plugins:
      - name: rate-limiting
        config:
          minute: 5  # Limit ingestion triggers
          policy: local
      - name: basic-auth
        config:
          hide_credentials: true

# Global Plugins
plugins:
  - name: cors
    config:
      origins:
        - "*"
      methods:
        - GET
        - POST
        - PUT
        - DELETE
        - OPTIONS
        - HEAD
        - PATCH
      headers:
        - Accept
        - Accept-Version
        - Content-Length
        - Content-MD5
        - Content-Type
        - Date
        - X-Auth-Token
        - Authorization
        - X-Request-ID
      exposed_headers:
        - X-Auth-Token
        - Content-Length
        - Content-Type
        - X-Request-ID
      credentials: true
      max_age: 3600
      preflight_continue: false

  - name: prometheus
    config:
      per_consumer: false

  # Circuit Breaker Plugin
  - name: response-transformer
    config:
      add:
        headers:
          - X-Kong-Proxy:true

# Simplified consumers without groups
consumers:
  - username: default-user
    custom_id: default-user-001